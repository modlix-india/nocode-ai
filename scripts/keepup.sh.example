#!/bin/bash
set -euo pipefail

HOME_DIR=/home/opc
COMPOSE_DIR=$HOME_DIR/composer/servers
RABBIT_DIR=$HOME_DIR/composer/rabbitmq
LOCK_FILE=/tmp/keepup.lock
cd "$COMPOSE_DIR" || exit 2

log() {
  echo "$(date '+%Y-%m-%d %H:%M:%S') -- $1"
}

# Acquire lock to prevent multiple instances (works across root and opc user)
exec 200>"$LOCK_FILE"

# Try to acquire lock (wait up to 5 minutes for deploy commands, immediate for health checks)
if [[ "${1:-}" == "deploy" ]] || [[ "${1:-}" == "restart" ]]; then
  # For deploy/restart: wait up to 5 minutes for lock
  if ! flock -w 300 200; then
    log "ERROR: Could not acquire lock after 5 minutes - another deployment is stuck"
    exit 1
  fi
  log "Lock acquired - proceeding with deployment"
else
  # For health checks: try immediately, skip if busy
  if ! flock -n 200; then
    log "Another deployment is in progress - skipping health check this time"
    exit 0
  fi
fi

# Make lock file accessible to both root and opc
chmod 666 "$LOCK_FILE" 2>/dev/null || true

# Ensure lock is released on exit
trap 'flock -u 200' EXIT

declare -A BLUE_PORTS
declare -A GREEN_PORTS
declare -A HEALTH_ENDPOINTS

# Singleton services (infrastructure - not blue-green)
CONFIG_PORT=8888
EUREKA_PORT=9999
GATEWAY_PORT=8080

# Blue-green application services
BLUE_PORTS["core-server"]=8005;      GREEN_PORTS["core-server"]=9005
BLUE_PORTS["ui-server"]=8002;        GREEN_PORTS["ui-server"]=9002
BLUE_PORTS["files-server"]=8003;     GREEN_PORTS["files-server"]=9003
BLUE_PORTS["multi-server"]=8006;     GREEN_PORTS["multi-server"]=9006
BLUE_PORTS["security-server"]=8001;  GREEN_PORTS["security-server"]=9001
BLUE_PORTS["entity-processor"]=8009; GREEN_PORTS["entity-processor"]=9009
BLUE_PORTS["entity-collector"]=8008; GREEN_PORTS["entity-collector"]=9008
BLUE_PORTS["message-server"]=8010;   GREEN_PORTS["message-server"]=9010
BLUE_PORTS["notification-server"]=8007; GREEN_PORTS["notification-server"]=9007
BLUE_PORTS["ai-server"]=5001;        GREEN_PORTS["ai-server"]=6001

# Health endpoints (default is /actuator/health for Java services)
# Python services use different endpoints
HEALTH_ENDPOINTS["ai-server"]="/health"

# Function to get health endpoint for a service
get_health_endpoint() {
  local svc="$1"
  echo "${HEALTH_ENDPOINTS[$svc]:-/actuator/health}"
}

# Function to check health of a service
check_health() {
  local port="$1"
  local endpoint="$2"
  curl -s "http://localhost:$port$endpoint" 2>/dev/null | grep -q "UP\|\"status\":\"UP\""
}

OCIR_REG="ocir.us-ashburn-1.oci.oraclecloud.com/idfmutpuhiky"

if [[ "${1:-}" == "stop" ]]; then
  log "Stopping all services"
  sudo docker compose stop
  exit 0
fi

if [[ "${1:-}" == "restart" ]]; then
  log "Restarting all services (blue instances only)"
  sudo docker compose down

  # Start singleton infrastructure services
  sudo docker compose up -d config-server eureka-server gateway-server

  # Start only BLUE instances of application services
  sudo docker compose up -d \
    core-server-blue \
    ui-server-blue \
    files-server-blue \
    multi-server-blue \
    security-server-blue \
    entity-processor-blue \
    entity-collector-blue \
    message-server-blue \
    notification-server-blue \
    ai-server-blue

  log "Restart completed - all BLUE instances started"
  exit 0
fi

if [[ "${1:-}" == "deploy" ]]; then
  SERVICE="$2"
  IMAGE="$3"

  if [[ -z "$SERVICE" || -z "$IMAGE" ]]; then
    echo "Usage: keepup.sh deploy <service> <image>"
    exit 1
  fi

  log "Deploy requested for $SERVICE"
  sudo docker pull "$IMAGE"

  COMPOSE_IMAGE="$OCIR_REG/dev-${SERVICE}:latest"
  sudo docker tag "$IMAGE" "$COMPOSE_IMAGE"

  # Infrastructure services are singletons, not blue-green
  if [[ "$SERVICE" == "config-server" ]]; then
    log "Restarting config-server (singleton)"
    sudo docker compose up -d config-server

    HEALTH=""
    for i in {1..20}; do
      HEALTH=$(curl -s "http://localhost:$CONFIG_PORT/actuator/health" || true)
      if [[ "$HEALTH" == *"UP"* ]]; then
        log "config-server is healthy"
        break
      fi
      sleep 3
    done

    if [[ "$HEALTH" != *"UP"* ]]; then
      log "config-server failed health check"
      exit 1
    fi

    log "config-server deployment completed"
    exit 0
  fi

  if [[ "$SERVICE" == "eureka-server" ]]; then
    log "Restarting eureka-server (singleton)"
    sudo docker compose up -d eureka-server

    HEALTH=""
    for i in {1..20}; do
      HEALTH=$(curl -s "http://localhost:$EUREKA_PORT/actuator/health" || true)
      if [[ "$HEALTH" == *"UP"* ]]; then
        log "eureka-server is healthy"
        break
      fi
      sleep 3
    done

    if [[ "$HEALTH" != *"UP"* ]]; then
      log "eureka-server failed health check"
      exit 1
    fi

    log "eureka-server deployment completed"
    exit 0
  fi

  if [[ "$SERVICE" == "gateway-server" ]]; then
    log "Restarting gateway-server (singleton)"
    sudo docker compose up -d gateway-server

    HEALTH=""
    for i in {1..20}; do
      HEALTH=$(curl -s "http://localhost:$GATEWAY_PORT/actuator/health" || true)
      if [[ "$HEALTH" == *"UP"* ]]; then
        log "gateway-server is healthy"
        break
      fi
      sleep 3
    done

    if [[ "$HEALTH" != *"UP"* ]]; then
      log "gateway-server failed health check"
      exit 1
    fi

    log "gateway-server deployment completed"
    exit 0
  fi

  BLUE="${SERVICE}-blue"
  GREEN="${SERVICE}-green"

  BLUE_PORT=${BLUE_PORTS[$SERVICE]}
  GREEN_PORT=${GREEN_PORTS[$SERVICE]}
  HEALTH_ENDPOINT=$(get_health_endpoint "$SERVICE")

  if sudo docker ps --format '{{.Names}}' | grep -qw "$BLUE"; then
    ACTIVE="blue"
    NEXT="$GREEN"
    NEXT_PORT="$GREEN_PORT"
  else
    ACTIVE="green"
    NEXT="$BLUE"
    NEXT_PORT="$BLUE_PORT"
  fi

  log "Starting $NEXT"
  sudo docker compose up -d "$NEXT"

  HEALTHY=false
  for i in {1..20}; do
    if check_health "$NEXT_PORT" "$HEALTH_ENDPOINT"; then
      log "$NEXT is healthy"
      HEALTHY=true
      break
    fi
    sleep 3
  done

  if [ "$HEALTHY" = false ]; then
    log "$NEXT failed health check"
    sudo docker compose stop "$NEXT" || true
    sudo docker compose rm -f "$NEXT" || true
    exit 1
  fi

  OLD="${SERVICE}-${ACTIVE}"
  log "Stopping old instance $OLD"
  sudo docker compose stop "$OLD" || true
  sudo docker compose rm -f "$OLD" || true

  log "Deployment completed for $SERVICE"
  exit 0
fi

log "Checking RabbitMQ"
if ! curl -s --max-time 5 http://localhost:15672 | grep -q html; then
  log "RabbitMQ DOWN → starting"
  cd "$RABBIT_DIR"
  sudo docker compose up -d rabbitmq
  cd "$COMPOSE_DIR"
else
  log "RabbitMQ UP"
fi

check_singleton_service() {
  SERVICE_NAME="$1"
  PORT="$2"

  log "Checking $SERVICE_NAME"
  if curl -s "http://localhost:$PORT/actuator/health" | grep -q UP; then
    log "$SERVICE_NAME healthy"
  else
    log "$SERVICE_NAME DOWN → starting"
    sudo docker compose up -d "$SERVICE_NAME"
  fi
}

check_service() {
  SVC="$1"
  BLUE="${SVC}-blue"
  GREEN="${SVC}-green"

  BLUE_PORT=${BLUE_PORTS[$SVC]}
  GREEN_PORT=${GREEN_PORTS[$SVC]}
  HEALTH_ENDPOINT=$(get_health_endpoint "$SVC")

  log "Checking $SVC"

  # Check health status
  BLUE_HEALTHY=false
  GREEN_HEALTHY=false

  if check_health "$BLUE_PORT" "$HEALTH_ENDPOINT"; then
    BLUE_HEALTHY=true
  fi

  if check_health "$GREEN_PORT" "$HEALTH_ENDPOINT"; then
    GREEN_HEALTHY=true
  fi

  # Both are healthy - keep only one running (prefer the currently active one)
  if [ "$BLUE_HEALTHY" = true ] && [ "$GREEN_HEALTHY" = true ]; then
    log "WARNING: Both $BLUE and $GREEN are running - stopping GREEN"
    sudo docker compose stop "$GREEN" || true
    log "$BLUE healthy (GREEN stopped)"
    return
  fi

  # Blue is healthy
  if [ "$BLUE_HEALTHY" = true ]; then
    log "$BLUE healthy"
    return
  fi

  # Green is healthy
  if [ "$GREEN_HEALTHY" = true ]; then
    log "$GREEN healthy"
    return
  fi

  # Both are down - start BLUE
  log "Both instances DOWN → starting BLUE"
  sudo docker compose up -d "$BLUE"
}

SERVICES=(
  core-server
  ui-server
  files-server
  multi-server
  security-server
  entity-processor
  entity-collector
  message-server
  notification-server
  ai-server
)

# Check singleton infrastructure services first
check_singleton_service "config-server" "$CONFIG_PORT"
check_singleton_service "eureka-server" "$EUREKA_PORT"
check_singleton_service "gateway-server" "$GATEWAY_PORT"

# Check all blue-green application services
for svc in "${SERVICES[@]}"; do
  check_service "$svc"
done

# Cleanup unused Docker images to free up disk space
log "Cleaning up unused Docker images"
sudo docker image prune -af --filter "until=168h" 2>&1 | grep -v "^$" || true
log "Docker cleanup completed"

log "KEEPUP COMPLETED"
exit 0

